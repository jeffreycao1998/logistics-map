// import axios from 'axios';
import { shipments } from '../index';
import { 
  ShipmentType, 
  // RouteType 
} from '../types';
// import fetchGeoJsonV2 from './fetchGeoJsonV2';
// import util from 'util';
import { initIndexArray, getAllCombinations } from './helpers';

const matrix = [
  [
    {
      from: [ -79.6248, 43.6777 ],
      to: [ -79.6248, 43.6777 ],
      distance: 0,
      duration: 0,
      coordinates: [ [ -79.625828, 43.678487 ], [ -79.625828, 43.678487 ] ]
    },
    {
      from: [ -79.6248, 43.6777 ],
      to: [ -79.4521, 43.7254, 0 ],
      distance: 18354.5,
      duration: 1531.9,
      coordinates: [
        [ -79.625828, 43.678487 ],
        [ -79.621984, 43.68111 ],
        [ -79.625927, 43.684221 ],
        [ -79.625181, 43.684741 ],
        [ -79.625483, 43.685121 ],
        [ -79.623424, 43.686381 ],
        [ -79.623361, 43.687838 ],
        [ -79.622187, 43.688665 ],
        [ -79.621356, 43.688352 ],
        [ -79.620788, 43.688772 ],
        [ -79.617193, 43.687578 ],
        [ -79.61748, 43.687044 ],
        [ -79.618553, 43.687012 ],
        [ -79.617257, 43.686782 ],
        [ -79.616943, 43.685939 ],
        [ -79.613359, 43.685098 ],
        [ -79.610208, 43.694833 ],
        [ -79.607762, 43.6969 ],
        [ -79.594714, 43.696611 ],
        [ -79.585236, 43.698313 ],
        [ -79.57523, 43.698745 ],
        [ -79.568617, 43.700783 ],
        [ -79.561972, 43.704953 ],
        [ -79.557132, 43.705399 ],
        [ -79.55207, 43.709187 ],
        [ -79.531032, 43.714183 ],
        [ -79.524307, 43.715542 ],
        [ -79.515539, 43.71657 ],
        [ -79.501481, 43.71754 ],
        [ -79.463249, 43.726539 ],
        [ -79.457601, 43.726709 ],
        [ -79.455475, 43.727922 ],
        [ -79.451953, 43.72864 ],
        [ -79.451216, 43.728435 ],
        [ -79.451013, 43.727256 ],
        [ -79.454486, 43.726419 ],
        [ -79.454264, 43.725885 ],
        [ -79.4523, 43.72631 ],
        [ -79.451934, 43.725436 ]
      ]
    },
    {
      from: [ -79.6248, 43.6777 ],
      to: [ -79.1815, 43.8207, 1 ],
      distance: 45822.1,
      duration: 2526.5,
      coordinates: [
        [ -79.625828, 43.678487 ],
        [ -79.621984, 43.68111 ],
        [ -79.625927, 43.684221 ],
        [ -79.623361, 43.687838 ],
        [ -79.620788, 43.688772 ],
        [ -79.613359, 43.685098 ],
        [ -79.607762, 43.6969 ],
        [ -79.573676, 43.699034 ],
        [ -79.550754, 43.709734 ],
        [ -79.526337, 43.715493 ],
        [ -79.491674, 43.720017 ],
        [ -79.441816, 43.731482 ],
        [ -79.392302, 43.76202 ],
        [ -79.372111, 43.76576 ],
        [ -79.311851, 43.768555 ],
        [ -79.24035, 43.783892 ],
        [ -79.214544, 43.793568 ],
        [ -79.174624, 43.799317 ],
        [ -79.165654, 43.798317 ],
        [ -79.173082, 43.81147 ],
        [ -79.173317, 43.817429 ],
        [ -79.177427, 43.82292 ],
        [ -79.180231, 43.82091 ]
      ]
    },
    {
      from: [ -79.6248, 43.6777 ],
      to: [ -79.5395, 43.843, 2 ],
      distance: 28352.4,
      duration: 1851.9,
      coordinates: [
        [ -79.625828, 43.678487 ],
        [ -79.621984, 43.68111 ],
        [ -79.625927, 43.684221 ],
        [ -79.623361, 43.687838 ],
        [ -79.620788, 43.688772 ],
        [ -79.613359, 43.685098 ],
        [ -79.607762, 43.6969 ],
        [ -79.573676, 43.699034 ],
        [ -79.5514, 43.709398 ],
        [ -79.518554, 43.715618 ],
        [ -79.523093, 43.723333 ],
        [ -79.544756, 43.814873 ],
        [ -79.546507, 43.847261 ],
        [ -79.541395, 43.848052 ],
        [ -79.541086, 43.846052 ],
        [ -79.537976, 43.846438 ],
        [ -79.538762, 43.842483 ]
      ]
    }
  ],
  [
    {
      from: [ -79.4521, 43.7254, 0 ],
      to: [ -79.6248, 43.6777 ],
      distance: 17728.3,
      duration: 1322.3,
      coordinates: [
        [ -79.451934, 43.725436 ],
        [ -79.4523, 43.72631 ],
        [ -79.454264, 43.725885 ],
        [ -79.454499, 43.726706 ],
        [ -79.457291, 43.726176 ],
        [ -79.457592, 43.729371 ],
        [ -79.456899, 43.728782 ],
        [ -79.45878, 43.728085 ],
        [ -79.489769, 43.720836 ],
        [ -79.497196, 43.719814 ],
        [ -79.502361, 43.718389 ],
        [ -79.524893, 43.71591 ],
        [ -79.543385, 43.711694 ],
        [ -79.54885, 43.710992 ],
        [ -79.554524, 43.709247 ],
        [ -79.557989, 43.705816 ],
        [ -79.562455, 43.704917 ],
        [ -79.568343, 43.701097 ],
        [ -79.573288, 43.699333 ],
        [ -79.57869, 43.698521 ],
        [ -79.585126, 43.698483 ],
        [ -79.59432, 43.696808 ],
        [ -79.60733, 43.697153 ],
        [ -79.609753, 43.695951 ],
        [ -79.61169, 43.693582 ],
        [ -79.614028, 43.686562 ],
        [ -79.616011, 43.686551 ],
        [ -79.618579, 43.687787 ],
        [ -79.622187, 43.688665 ],
        [ -79.627291, 43.685274 ],
        [ -79.621984, 43.68111 ],
        [ -79.625828, 43.678487 ]
      ]
    },
    {
      from: [ -79.4521, 43.7254, 0 ],
      to: [ -79.4521, 43.7254, 0 ],
      distance: 0,
      duration: 0,
      coordinates: [ [ -79.451934, 43.725436 ], [ -79.451934, 43.725436 ] ]
    },
    {
      from: [ -79.4521, 43.7254, 0 ],
      to: [ -79.1815, 43.8207, 1 ],
      distance: 29444.3,
      duration: 1739.8,
      coordinates: [
        [ -79.451934, 43.725436 ],
        [ -79.4523, 43.72631 ],
        [ -79.454486, 43.726419 ],
        [ -79.45007, 43.727417 ],
        [ -79.449261, 43.725517 ],
        [ -79.44703, 43.725884 ],
        [ -79.447519, 43.727636 ],
        [ -79.445739, 43.729325 ],
        [ -79.441741, 43.730708 ],
        [ -79.425942, 43.740303 ],
        [ -79.398888, 43.759089 ],
        [ -79.391827, 43.761933 ],
        [ -79.373203, 43.765501 ],
        [ -79.311774, 43.768398 ],
        [ -79.24035, 43.783892 ],
        [ -79.227914, 43.787666 ],
        [ -79.214544, 43.793568 ],
        [ -79.174624, 43.799317 ],
        [ -79.17026, 43.799467 ],
        [ -79.165654, 43.798317 ],
        [ -79.173082, 43.81147 ],
        [ -79.173317, 43.817429 ],
        [ -79.177427, 43.82292 ],
        [ -79.180231, 43.82091 ]
      ]
    },
    {
      from: [ -79.4521, 43.7254, 0 ],
      to: [ -79.5395, 43.843, 2 ],
      distance: 22403.8,
      duration: 1339,
      coordinates: [
        [ -79.451934, 43.725436 ],
        [ -79.454499, 43.726706 ],
        [ -79.457291, 43.726176 ],
        [ -79.457343, 43.729405 ],
        [ -79.456899, 43.728782 ],
        [ -79.45878, 43.728085 ],
        [ -79.503627, 43.718453 ],
        [ -79.515266, 43.717394 ],
        [ -79.519829, 43.718948 ],
        [ -79.521929, 43.720923 ],
        [ -79.544756, 43.814873 ],
        [ -79.547446, 43.841545 ],
        [ -79.546507, 43.847261 ],
        [ -79.541395, 43.848052 ],
        [ -79.541086, 43.846052 ],
        [ -79.537976, 43.846438 ],
        [ -79.537168, 43.842733 ],
        [ -79.538762, 43.842483 ]
      ]
    }
  ],
  [
    {
      from: [ -79.1815, 43.8207, 1 ],
      to: [ -79.6248, 43.6777 ],
      distance: 44847.3,
      duration: 2237.2,
      coordinates: [
        [ -79.180231, 43.82091 ],
        [ -79.177427, 43.82292 ],
        [ -79.172914, 43.816778 ],
        [ -79.168518, 43.800644 ],
        [ -79.21444, 43.79417 ],
        [ -79.240485, 43.784213 ],
        [ -79.311954, 43.768737 ],
        [ -79.372136, 43.765921 ],
        [ -79.39274, 43.762096 ],
        [ -79.442102, 43.731593 ],
        [ -79.491726, 43.720209 ],
        [ -79.54885, 43.710992 ],
        [ -79.574588, 43.699058 ],
        [ -79.60733, 43.697153 ],
        [ -79.61169, 43.693582 ],
        [ -79.614028, 43.686562 ],
        [ -79.622187, 43.688665 ],
        [ -79.627291, 43.685274 ],
        [ -79.621984, 43.68111 ],
        [ -79.625828, 43.678487 ]
      ]
    },
    {
      from: [ -79.1815, 43.8207, 1 ],
      to: [ -79.4521, 43.7254, 0 ],
      distance: 28963.7,
      duration: 1539.4,
      coordinates: [
        [ -79.180231, 43.82091 ],
        [ -79.177427, 43.82292 ],
        [ -79.172914, 43.816778 ],
        [ -79.173082, 43.81147 ],
        [ -79.167634, 43.801759 ],
        [ -79.168518, 43.800644 ],
        [ -79.21444, 43.79417 ],
        [ -79.229595, 43.787423 ],
        [ -79.240485, 43.784213 ],
        [ -79.311954, 43.768737 ],
        [ -79.372136, 43.765921 ],
        [ -79.39274, 43.762096 ],
        [ -79.399568, 43.759172 ],
        [ -79.414722, 43.749487 ],
        [ -79.418713, 43.745391 ],
        [ -79.437987, 43.733633 ],
        [ -79.449775, 43.730155 ],
        [ -79.450355, 43.730873 ],
        [ -79.449077, 43.727665 ],
        [ -79.454486, 43.726419 ],
        [ -79.4523, 43.72631 ],
        [ -79.451934, 43.725436 ]
      ]
    },
    {
      from: [ -79.1815, 43.8207, 1 ],
      to: [ -79.1815, 43.8207, 1 ],
      distance: 0,
      duration: 0,
      coordinates: [ [ -79.182355, 43.820556 ], [ -79.182355, 43.820556 ] ]
    },
    {
      from: [ -79.1815, 43.8207, 1 ],
      to: [ -79.5395, 43.843, 2 ],
      distance: 50110.7,
      duration: 2249.4,
      coordinates: [
        [ -79.180231, 43.82091 ],
        [ -79.177427, 43.82292 ],
        [ -79.172914, 43.816778 ],
        [ -79.168518, 43.800644 ],
        [ -79.215974, 43.793915 ],
        [ -79.238687, 43.784857 ],
        [ -79.310898, 43.769137 ],
        [ -79.331546, 43.768715 ],
        [ -79.338395, 43.771551 ],
        [ -79.346902, 43.809856 ],
        [ -79.359053, 43.817479 ],
        [ -79.365672, 43.835912 ],
        [ -79.368886, 43.838888 ],
        [ -79.388113, 43.836883 ],
        [ -79.415875, 43.838622 ],
        [ -79.462759, 43.825688 ],
        [ -79.477587, 43.817644 ],
        [ -79.481222, 43.803885 ],
        [ -79.488598, 43.796054 ],
        [ -79.519901, 43.787075 ],
        [ -79.533465, 43.785402 ],
        [ -79.537707, 43.788257 ],
        [ -79.544459, 43.813458 ],
        [ -79.546507, 43.847261 ],
        [ -79.541395, 43.848052 ],
        [ -79.541086, 43.846052 ],
        [ -79.537976, 43.846438 ],
        [ -79.538762, 43.842483 ]
      ]
    }
  ],
  [
    {
      from: [ -79.5395, 43.843, 2 ],
      to: [ -79.6248, 43.6777 ],
      distance: 26868.4,
      duration: 1692.3,
      coordinates: [
        [ -79.538762, 43.842483 ],
        [ -79.537666, 43.837548 ],
        [ -79.534336, 43.838338 ],
        [ -79.532781, 43.830939 ],
        [ -79.548117, 43.828566 ],
        [ -79.540209, 43.793915 ],
        [ -79.540899, 43.783717 ],
        [ -79.603312, 43.761745 ],
        [ -79.630073, 43.755984 ],
        [ -79.632743, 43.75392 ],
        [ -79.626389, 43.729409 ],
        [ -79.609546, 43.697886 ],
        [ -79.613798, 43.68671 ],
        [ -79.622187, 43.688665 ],
        [ -79.627291, 43.685274 ],
        [ -79.621984, 43.68111 ],
        [ -79.625828, 43.678487 ]
      ]
    },
    {
      from: [ -79.5395, 43.843, 2 ],
      to: [ -79.4521, 43.7254, 0 ],
      distance: 22584.3,
      duration: 1512.8,
      coordinates: [
        [ -79.538762, 43.842483 ],
        [ -79.537168, 43.842733 ],
        [ -79.53647, 43.838102 ],
        [ -79.537666, 43.837548 ],
        [ -79.534336, 43.838338 ],
        [ -79.532781, 43.830939 ],
        [ -79.542493, 43.828755 ],
        [ -79.548117, 43.828566 ],
        [ -79.546931, 43.828864 ],
        [ -79.546366, 43.827119 ],
        [ -79.544707, 43.812867 ],
        [ -79.523726, 43.724407 ],
        [ -79.519371, 43.716908 ],
        [ -79.517123, 43.715787 ],
        [ -79.501481, 43.71754 ],
        [ -79.463249, 43.726539 ],
        [ -79.457601, 43.726709 ],
        [ -79.451953, 43.72864 ],
        [ -79.451013, 43.727256 ],
        [ -79.454486, 43.726419 ],
        [ -79.4523, 43.72631 ],
        [ -79.451934, 43.725436 ]
      ]
    },
    {
      from: [ -79.5395, 43.843, 2 ],
      to: [ -79.1815, 43.8207, 1 ],
      distance: 49922.4,
      duration: 2397.2,
      coordinates: [
        [ -79.538762, 43.842483 ],
        [ -79.537666, 43.837548 ],
        [ -79.534336, 43.838338 ],
        [ -79.532781, 43.830939 ],
        [ -79.548117, 43.828566 ],
        [ -79.539366, 43.7851 ],
        [ -79.535011, 43.782549 ],
        [ -79.488223, 43.795977 ],
        [ -79.481357, 43.802688 ],
        [ -79.477213, 43.817583 ],
        [ -79.463775, 43.825078 ],
        [ -79.416612, 43.838231 ],
        [ -79.378968, 43.837172 ],
        [ -79.337356, 43.843629 ],
        [ -79.273732, 43.857531 ],
        [ -79.243626, 43.867826 ],
        [ -79.201558, 43.877355 ],
        [ -79.184888, 43.888815 ],
        [ -79.170264, 43.855498 ],
        [ -79.179991, 43.853147 ],
        [ -79.173267, 43.838258 ],
        [ -79.182905, 43.835942 ],
        [ -79.177427, 43.82292 ],
        [ -79.180231, 43.82091 ]
      ]
    },
    {
      from: [ -79.5395, 43.843, 2 ],
      to: [ -79.5395, 43.843, 2 ],
      distance: 0,
      duration: 0,
      coordinates: [ [ -79.538762, 43.842483 ], [ -79.538762, 43.842483 ] ]
    }
  ]
];

const extractWaypoints = (shipments: Array<ShipmentType>) => {
  const waypoints = [];

  for (let shipment of shipments) {
    waypoints.push({
      id: shipment.id,
      type: 'pickup',
      location: shipment.pickupLocation
    });
    waypoints.push({
      id: shipment.id,
      type: 'dropoff',
      location: shipment.dropoffLocation
    });
  }

  return waypoints;
};

// const initMatrix = (totalShipments: number) => {
//   const matrix = [] as Array<Array<any>>;

//   for (let i = 0; i < totalShipments; i++) {
//     matrix.push([]);
//   }

//   return matrix;
// };

// const createMatrix = async (shipments: Array<ShipmentType>) => {
//   const waypoints = extractWaypoints(shipments);
//   const matrix = initMatrix(shipments.length * 2) as Array<Array<any>>;

//   for (let i = 0; i < waypoints.length; i++) {
//     for (let j = 0; j < waypoints.length; j++) {
//       const urlWaypoints = `${waypoints[i].location[0]},${waypoints[i].location[1]};${waypoints[j].location[0]},${waypoints[j].location[1]}`;
//       const url = `https://api.mapbox.com/optimized-trips/v1/mapbox/driving/${urlWaypoints}?source=first&destination=last&roundtrip=false&geometries=geojson&access_token=${process.env.MAPBOX_ACCESS_KEY}`;
//       await axios.get(url)
//       .then(res => {
//         matrix[i][j] = {
//           from: [...waypoints[i].location],
//           to: [...waypoints[j].location],
//           distance: res.data.trips[0].distance,
//           duration: res.data.trips[0].duration,
//           coordinates: res.data.trips[0].geometry.coordinates
//         }
//       })
//       .catch(err => console.log(err));
//     }
//   };

//   return matrix;
// };

const getAllTotalDistances = async (shipments: Array<ShipmentType>) => {
  // const matrix = await createMatrix(shipments);
  const startTime = (new Date).getTime();
  const waypoints = extractWaypoints(shipments);
  const indexesArray = initIndexArray(waypoints.length);

  const combinations = getAllCombinations(indexesArray, 0, []);

  let shortestDistanceCombination = null;
  let shortestDistance = Infinity;

  for (let combination of combinations) {
    let lastIndex = null;
    let totalDistance = 0;
    combination.push(combination[0]);

    // skip combination if combination doesn't start where we want it to start
    const startingPoint = 0;
    if (combination[0] !== startingPoint) {
      continue;
    }

    for (let index of combination) {
      if (lastIndex === null) {
        lastIndex = index;
        continue;
      }

      const distance = matrix[lastIndex][index].distance;
      totalDistance += distance;
      lastIndex = index;
    }

    if (totalDistance < shortestDistance) {
      shortestDistanceCombination = combination;
      shortestDistance = totalDistance;
    }
  }

  console.log(shortestDistanceCombination);
  console.log(shortestDistance);
  const endTime = (new Date).getTime();
  console.log(endTime - startTime);
};

getAllTotalDistances(shipments);